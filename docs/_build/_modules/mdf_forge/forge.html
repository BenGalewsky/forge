
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>mdf_forge.forge &#8212; mdf_forge 0.4.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.4.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for mdf_forge.forge</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">globus_sdk</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">mdf_forge</span> <span class="k">import</span> <span class="n">toolbox</span>

<span class="c1"># Maximum recommended number of HTTP file transfers</span>
<span class="c1"># Large transfers are much better suited to Globus Transfer use</span>
<span class="n">HTTP_NUM_LIMIT</span> <span class="o">=</span> <span class="mi">10</span>
<span class="c1"># Maximum number of results per search allowed by Globus Search</span>
<span class="n">SEARCH_LIMIT</span> <span class="o">=</span> <span class="mi">10000</span>


<div class="viewcode-block" id="Forge"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Forge">[docs]</a><span class="k">class</span> <span class="nc">Forge</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Fetch metadata from Globus Search and files from the Materials Data Facility.</span>
<span class="sd">    Forge is intended to be the best way to access MDF data for all users.</span>
<span class="sd">    An internal Query object is used to make queries. From the user&#39;s perspective,</span>
<span class="sd">    an instantiation of Forge will black-box searching.</span>

<span class="sd">    Public Variables:</span>
<span class="sd">    local_ep is the endpoint ID of the local Globus Connect Personal endpoint.</span>

<span class="sd">    Methods:</span>
<span class="sd">    __init__ handles authentication with Globus Auth.</span>
<span class="sd">    match_term adds simple terms to the query.</span>
<span class="sd">    match_field adds a field:value pair to the query.</span>
<span class="sd">    match_sources specifies `source_name`s to search for results in.</span>
<span class="sd">    match_elements specifies element abbreviations to match.</span>
<span class="sd">    search executes a search.</span>
<span class="sd">    search_by_elements executes a search for given elements in given sources.</span>
<span class="sd">    aggregate_source returns all records for a given source.</span>
<span class="sd">    reset_query destroys the current query and starts a fresh one.</span>
<span class="sd">    http_download saves the data files associated with results to disk with HTTPS.</span>
<span class="sd">    globus_download saves the data files associated with results to disk with Globus Transfer.</span>
<span class="sd">    http_stream yields a generator to fetch data files in sequence.</span>
<span class="sd">    http_return returns all the data files at once.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__index</span> <span class="o">=</span> <span class="s2">&quot;mdf&quot;</span>
    <span class="n">__services</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mdf&quot;</span><span class="p">,</span> <span class="s2">&quot;transfer&quot;</span><span class="p">,</span> <span class="s2">&quot;search&quot;</span><span class="p">]</span>
    <span class="n">__app_name</span> <span class="o">=</span> <span class="s2">&quot;MDF_Forge&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Forge instance.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">        index (str): The Globus Search index to search on.</span>
<span class="sd">        services (list of str): The services to authenticate for.</span>
<span class="sd">        local_ep (str): The endpoint ID of the local Globus Connect Personal endpoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__services</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;services&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__services</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_ep</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;local_ep&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">clients</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">credentials</span><span class="o">=</span><span class="p">{</span>
                                <span class="s2">&quot;app_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__app_name</span><span class="p">,</span>
                                <span class="s2">&quot;services&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__services</span><span class="p">,</span>
                                <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__index</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__search_client</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s2">&quot;search&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__transfer_client</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s2">&quot;transfer&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mdf_authorizer</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s2">&quot;mdf&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__search_client</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">search_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__search_client</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">transfer_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__transfer_client</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mdf_authorizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mdf_authorizer</span>

<div class="viewcode-block" id="Forge.match_term"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Forge.match_term">[docs]</a>    <span class="k">def</span> <span class="nf">match_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">match_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a term to the query.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        term (str): The term to add.</span>
<span class="sd">        match_all (bool): If True, will add term with AND. If False, will use OR. Default True.</span>

<span class="sd">        Returns:</span>
<span class="sd">        self (Forge): For chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__query</span><span class="o">.</span><span class="n">match_term</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">term</span><span class="p">,</span> <span class="n">match_all</span><span class="o">=</span><span class="n">match_all</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Forge.match_field"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Forge.match_field">[docs]</a>    <span class="k">def</span> <span class="nf">match_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">match_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a field:value term to the query.</span>
<span class="sd">        Matches will have field == value.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        field (str): The field to look in for the value.</span>
<span class="sd">            The field must be namespaced according to Elasticsearch rules, which means a dot to dive into dictionaries.</span>
<span class="sd">            Ex. &quot;mdf.source_name&quot; is the &quot;source_name&quot; field of the &quot;mdf&quot; dictionary.</span>
<span class="sd">            If no namespace is provided, the default (&quot;mdf.&quot;) will be used.</span>
<span class="sd">        value (str): The value to match.</span>
<span class="sd">        match_all: If True, will add with AND. If False, will use OR. Default True.</span>
<span class="sd"> </span>
<span class="sd">        Returns:</span>
<span class="sd">        self (Forge): For chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__query</span><span class="o">.</span><span class="n">match_field</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">match_all</span><span class="o">=</span><span class="n">match_all</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Forge.match_sources"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Forge.match_sources">[docs]</a>    <span class="k">def</span> <span class="nf">match_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add sources to match to the query.</span>
<span class="sd">        match_sources(x) is equivalent to match_field(&quot;mdf.source_name&quot;, x, match_all=False)</span>

<span class="sd">        Arguments:</span>
<span class="sd">        sources (str or list): The sources to match.</span>
<span class="sd"> </span>
<span class="sd">        Returns:</span>
<span class="sd">        self (Forge): For chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__query</span><span class="o">.</span><span class="n">match_field</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;mdf.source_name&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span> <span class="n">match_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Forge.match_elements"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Forge.match_elements">[docs]</a>    <span class="k">def</span> <span class="nf">match_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">match_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add elemental abbreviations to the query.</span>
<span class="sd">        match_elements(x) is equivalent to match_field(&quot;mdf.elements&quot;, x)</span>

<span class="sd">        Arguments:</span>
<span class="sd">        elements (str or list): The elements to match.</span>
<span class="sd">        match_all: If True, will add with AND. If False, will use OR. Default True.</span>
<span class="sd"> </span>
<span class="sd">        Returns:</span>
<span class="sd">        self (Forge): For chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__query</span><span class="o">.</span><span class="n">match_field</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;mdf.elements&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">elements</span><span class="p">,</span> <span class="n">match_all</span><span class="o">=</span><span class="n">match_all</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Forge.search"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Forge.search">[docs]</a>    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">advanced</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">SEARCH_LIMIT</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reset_query</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute a search and return the results.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        q (str): The query to execute. Defaults to the current query, if any. There must be some query to execute.</span>
<span class="sd">        advanced (bool): If True, will submit query in &quot;advanced&quot; mode, which enables searches other than basic fulltext.</span>
<span class="sd">                         If False, only basic fulltext term matches will be supported.</span>
<span class="sd">                         Default False.</span>
<span class="sd">                         This value can change to True automatically if the query is built using advanced features, such as match_field.</span>
<span class="sd">        limit (int): The maximum number of results to return. The max for this argument is the SEARCH_LIMIT imposed by Globus Search.</span>
<span class="sd">        info (bool): If False, search will return a list of the results.</span>
<span class="sd">                     If True, search will return a tuple containing the results list, and other information about the query.</span>
<span class="sd">                     Default False.</span>
<span class="sd">        reset_query (bool): If True, will destroy the query after execution and start a fresh one. Does nothing if False.</span>
<span class="sd">                            Default True.</span>

<span class="sd">        Returns:</span>
<span class="sd">        list (if info=False): The results.</span>
<span class="sd">        tuple (if info=True): The results, and a dictionary of query information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__query</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">advanced</span><span class="o">=</span><span class="n">advanced</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reset_query</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_query</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="Forge.search_by_elements"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Forge.search_by_elements">[docs]</a>    <span class="k">def</span> <span class="nf">search_by_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="o">=</span><span class="p">[],</span> <span class="n">sources</span><span class="o">=</span><span class="p">[],</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">match_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reset_query</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute a search for the given elements in the given sources.</span>
<span class="sd">        search_by_elements([x], [y]) is equivalent to match_elements([x]).match_sources([y]).search()</span>
<span class="sd">        Note that this method does use terms from the current query.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        elements (list of str): The elements to match. Default [].</span>
<span class="sd">        sources (list of str): The sources to match. Default [].</span>
<span class="sd">        limit (int): The maximum number of results to return. The max for this argument is the SEARCH_LIMIT imposed by Globus Search.</span>
<span class="sd">        info (bool): If False, search will return a list of the results.</span>
<span class="sd">                     If True, search will return a tuple containing the results list, and other information about the query.</span>
<span class="sd">                     Default False.</span>
<span class="sd">        reset_query (bool): If True, will destroy the query after execution and start a fresh one. Does nothing if False.</span>
<span class="sd">                            Default True.</span>

<span class="sd">        Returns:</span>
<span class="sd">        list (if info=False): The results.</span>
<span class="sd">        tuple (if info=True): The results, and a dictionary of query information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_elements</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">match_all</span><span class="o">=</span><span class="n">match_all</span><span class="p">)</span><span class="o">.</span><span class="n">match_sources</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">reset_query</span><span class="o">=</span><span class="n">reset_query</span><span class="p">)</span></div>


<div class="viewcode-block" id="Forge.aggregate_source"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Forge.aggregate_source">[docs]</a>    <span class="k">def</span> <span class="nf">aggregate_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Aggregate all records from a given source.</span>
<span class="sd">        There is no inherent limit to the number of results returned.</span>
<span class="sd">        Note that this method does not use or alter the current query.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        source (str): The source to aggregate.</span>
<span class="sd">        limit (int): The maximum number of results to return. Default None, to return all results.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        list of dict: All of the records from the source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__search_client</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate_source</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span></div>


<div class="viewcode-block" id="Forge.aggregate"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Forge.aggregate">[docs]</a>    <span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scroll_size</span><span class="o">=</span><span class="n">SEARCH_LIMIT</span><span class="p">,</span> <span class="n">reset_query</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform an advanced query, and return all matching results.</span>
<span class="sd">        Will automatically preform multiple queries in order to retrieve all results.</span>

<span class="sd">        Note that all aggregate queries run in advanced mode.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        q (str): The query to execute. Defaults to the current query, if any. There must be some query to execute.</span>
<span class="sd">        scroll_size (int): Minimum number of records returned per query</span>
<span class="sd">        reset_query (bool): If True, will destroy the query after execution and start a fresh one. Does nothing if False.</span>
<span class="sd">                            Default True.</span>

<span class="sd">        Returns:</span>
<span class="sd">        list of dict: All matching records</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__query</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">scroll_size</span><span class="o">=</span><span class="n">scroll_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reset_query</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_query</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="Forge.reset_query"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Forge.reset_query">[docs]</a>    <span class="k">def</span> <span class="nf">reset_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Destroy the current query and create a fresh, clean one.&quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__search_client</span><span class="p">)</span></div>


<div class="viewcode-block" id="Forge.http_download"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Forge.http_download">[docs]</a>    <span class="k">def</span> <span class="nf">http_download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">preserve_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Download data files from the provided results using HTTPS.</span>
<span class="sd">        For more than HTTP_NUM_LIMIT (defined above) files, you should use globus_download(), which uses Globus Transfer.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        results (dict): The records from which files should be fetched.</span>
<span class="sd">                        This should be the return value of a search method.</span>
<span class="sd">        dest (str): The destination path for the data files on the local machine. Default current directory.</span>
<span class="sd">        preserve_dir (bool): If True, the directory structure for the data files will be recreated at the destination.</span>
<span class="sd">                             If False, only the data files themselves will be saved.</span>
<span class="sd">                            Default False.</span>
<span class="sd">        verbose (bool): If True, status and progress messages will be printed.</span>
<span class="sd">                        If False, only error messages will be printed.</span>
<span class="sd">                        Default True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If results have info attached, remove it</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">HTTP_NUM_LIMIT</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Too many results supplied. Use globus_download() for fetching more than &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">HTTP_NUM_LIMIT</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; entries.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Too many results supplied. Use globus_download() for fetching more than &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">HTTP_NUM_LIMIT</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; entries.&quot;</span>
                <span class="p">}</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Fetching files&quot;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;mdf&quot;</span><span class="p">][</span><span class="s2">&quot;links&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Fetching files&quot;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>  <span class="c1"># not verbose):</span>
                <span class="n">dl</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;mdf&quot;</span><span class="p">][</span><span class="s2">&quot;links&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                <span class="n">host</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http_host&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dl</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">host</span><span class="p">:</span>
                    <span class="n">remote_path</span> <span class="o">=</span> <span class="n">dl</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>
                    <span class="c1"># local_path should be either dest + whole path or dest + filename, depending on preserve_dir</span>
                    <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">dest</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">dl</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">preserve_dir</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">dest</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dl</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]))</span>
                    <span class="c1"># Make dirs for storing the file if they don&#39;t exist</span>
                    <span class="c1"># preserve_dir doesn&#39;t matter; local_path has accounted for it already</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">local_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># If dest is current dir and preserve_dir=False, there are no dirs to make and os.makedirs() will raise FileNotFoundError.</span>
                    <span class="c1"># Since it means all dirs required exist, it can be swallowed.</span>
                    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># Check if file already exists, change filename if necessary</span>
                    <span class="n">collisions</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
                        <span class="c1"># Find period marking extension, if exists</span>
                        <span class="c1"># Will be after last slash</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="n">local_path</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">local_path</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ext</span> <span class="o">=</span> <span class="n">local_path</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>
                            <span class="n">local_path</span> <span class="o">=</span> <span class="n">local_path</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span>
                        <span class="c1"># Check if already added number to end</span>
                        <span class="n">old_add</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">collisions</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
                        <span class="n">collisions</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">new_add</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">collisions</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
                        <span class="k">if</span> <span class="n">local_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">old_add</span><span class="p">):</span>
                            <span class="n">local_path</span> <span class="o">=</span> <span class="n">local_path</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">old_add</span><span class="p">)]</span> <span class="o">+</span> <span class="n">new_add</span> <span class="o">+</span> <span class="n">ext</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">local_path</span> <span class="o">=</span> <span class="n">local_path</span> <span class="o">+</span> <span class="n">new_add</span> <span class="o">+</span> <span class="n">ext</span>
                    <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__mdf_authorizer</span><span class="o">.</span><span class="n">set_authorization_header</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span><span class="o">+</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
                    <span class="c1"># Handle first 401 by regenerating auth headers</span>
                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__mdf_authorizer</span><span class="o">.</span><span class="n">handle_missing_authorization</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__mdf_authorizer</span><span class="o">.</span><span class="n">set_authorization_header</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span><span class="o">+</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
                    <span class="c1"># Handle other errors by passing the buck to the user</span>
                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="s2">&quot; when attempting to access &#39;&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">+</span><span class="n">remote_path</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Write out the binary response content</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
                            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span></div>


<div class="viewcode-block" id="Forge.globus_download"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Forge.globus_download">[docs]</a>    <span class="k">def</span> <span class="nf">globus_download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">dest_ep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preserve_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wait_for_completion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Download data files from the provided results using Globus Transfer.</span>
<span class="sd">        This method requires Globus Connect to be installed on the destination endpoint.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        results (dict): The records from which files should be fetched.</span>
<span class="sd">                        This should be the return value of a search method.</span>
<span class="sd">        dest (str): The destination path for the data files on the local machine. Default current directory.</span>
<span class="sd">        preserve_dir (bool): If True, the directory structure for the data files will be recreated at the destination.</span>
<span class="sd">                                The path to tne new files will be relative to the `dest` path</span>
<span class="sd">                             If False, only the data files themselves will be saved.</span>
<span class="sd">                             Default False.</span>
<span class="sd">        wait_for_completion (bool): If True, will block until the transfer is finished.</span>
<span class="sd">                                    If False, will not block.</span>
<span class="sd">                                    Default True.</span>
<span class="sd">        verbose (bool): If True, status and progress messages will be printed.</span>
<span class="sd">                        If False, only error messages will be printed.</span>
<span class="sd">                        Default True.</span>

<span class="sd">        Returns:</span>
<span class="sd">        list of str: task IDs of the Gloubs transfers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
        <span class="c1"># If results have info attached, remove it</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dest_ep</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_ep</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">local_ep</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">get_local_ep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__transfer_client</span><span class="p">)</span>
            <span class="n">dest_ep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_ep</span>

        <span class="c1"># Assemble the transfer data</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing records&quot;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;mdf&quot;</span><span class="p">][</span><span class="s2">&quot;links&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Fetching files&quot;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> 

                <span class="c1"># Get the location of the data</span>
                <span class="n">dl</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;mdf&quot;</span><span class="p">][</span><span class="s2">&quot;links&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                <span class="n">host</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;globus_endpoint&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dl</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span>

                <span class="c1"># If the data is on a Globus Endpoint</span>
                <span class="c1">#   LW 9Aug17: Should we at least throw a warning if the data isn&#39;t on an endpoint?</span>
                <span class="k">if</span> <span class="n">host</span><span class="p">:</span>
                    <span class="n">remote_path</span> <span class="o">=</span> <span class="n">dl</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>
                    <span class="c1"># local_path should be either dest + whole path or dest + filename, depending on preserve_dir</span>
                    <span class="k">if</span> <span class="n">preserve_dir</span><span class="p">:</span>
                        <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dest</span> <span class="o">+</span> <span class="n">remote_path</span><span class="p">)</span> <span class="c1"># remote_path is absolute, so os.path.join does not work!</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)))</span>

                    <span class="c1"># Make dirs for storing the file if they don&#39;t exist</span>
                    <span class="c1"># preserve_dir doesn&#39;t matter; local_path has accounted for it already</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">local_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">local_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># If dest is current dir and preserve_dir=False, there are no dirs to make and os.makedirs() will raise FileNotFoundError.</span>
                    <span class="c1"># Since it means all dirs required exist, it can be swallowed.</span>
                    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                        <span class="k">pass</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">preserve_dir</span><span class="p">:</span>
                        <span class="c1"># Check if file already exists, change filename if necessary</span>
                        <span class="c1">#   The pattern is to add a number just before the extension (e.g., myfile(1).ext)</span>
                        <span class="n">collisions</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">local_path</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                            <span class="c1"># Find period marking extension, if exists</span>
                            <span class="c1"># Will be after last slash</span>
                            <span class="n">index</span> <span class="o">=</span> <span class="n">local_path</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">local_path</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ext</span> <span class="o">=</span> <span class="n">local_path</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>
                                <span class="n">local_path</span> <span class="o">=</span> <span class="n">local_path</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span>
                            <span class="c1"># Check if already added number to end</span>
                            <span class="n">old_add</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">collisions</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
                            <span class="n">collisions</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">new_add</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">collisions</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
                            <span class="k">if</span> <span class="n">local_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">old_add</span><span class="p">):</span>
                                <span class="n">local_path</span> <span class="o">=</span> <span class="n">local_path</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">old_add</span><span class="p">)]</span> <span class="o">+</span> <span class="n">new_add</span> <span class="o">+</span> <span class="n">ext</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">local_path</span> <span class="o">=</span> <span class="n">local_path</span> <span class="o">+</span> <span class="n">new_add</span> <span class="o">+</span> <span class="n">ext</span>

                    <span class="c1"># Add data to a transfer data object</span>
                    <span class="c1">#   LW 11Aug17: TODO, handle transfers with huge number of files</span>
                    <span class="c1">#      - If a TransferData object is too large. Globus might timeout before it can be completely uploaded</span>
                    <span class="c1">#        So, we need to be able to check the size of the TD object, and - if need be - send it early</span>
                    <span class="k">if</span> <span class="n">host</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tasks</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">tasks</span><span class="p">[</span><span class="n">host</span><span class="p">]</span> <span class="o">=</span> <span class="n">globus_sdk</span><span class="o">.</span><span class="n">TransferData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__transfer_client</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">dest_ep</span><span class="p">,</span> <span class="n">verify_checksum</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">tasks</span><span class="p">[</span><span class="n">host</span><span class="p">]</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
                    <span class="n">filenames</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>

        <span class="c1"># Submit the jobs</span>
        <span class="n">submissions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">td</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Submitting transfers&quot;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__transfer_client</span><span class="o">.</span><span class="n">submit_transfer</span><span class="p">(</span><span class="n">td</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Accepted&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error submitting transfer:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">wait_for_completion</span><span class="p">:</span>
                    <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__transfer_client</span><span class="o">.</span><span class="n">task_wait</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;task_id&quot;</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">polling_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transferring...&quot;</span><span class="p">)</span>
                <span class="n">submissions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;task_id&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All transfers submitted&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Task IDs:&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">submissions</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">submissions</span></div>

<div class="viewcode-block" id="Forge.http_stream"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Forge.http_stream">[docs]</a>    <span class="k">def</span> <span class="nf">http_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield data files from the provided results using HTTPS, through a generator.</span>
<span class="sd">        For more than HTTP_NUM_LIMIT (defined above) files, you should use globus_download(), which uses Globus Transfer.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        results (dict): The records from which files should be fetched.</span>
<span class="sd">                        This should be the return value of a search method.</span>
<span class="sd">        verbose (bool): If True, status and progress messages will be printed.</span>
<span class="sd">                        If False, only error messages will be printed.</span>
<span class="sd">                        Default True.</span>

<span class="sd">        Yields:</span>
<span class="sd">        str: Text of each data file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If results have info attached, remove it</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">HTTP_NUM_LIMIT</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Too many results supplied. Use globus_download() for fetching more than &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">HTTP_NUM_LIMIT</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; entries.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Too many results supplied. Use globus_download() for fetching more than &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">HTTP_NUM_LIMIT</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; entries.&quot;</span>
                <span class="p">}</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;mdf&quot;</span><span class="p">][</span><span class="s2">&quot;links&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">dl</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;mdf&quot;</span><span class="p">][</span><span class="s2">&quot;links&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                <span class="n">host</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http_host&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dl</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">host</span><span class="p">:</span>
                    <span class="n">remote_path</span> <span class="o">=</span> <span class="n">dl</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>
                    <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__mdf_authorizer</span><span class="o">.</span><span class="n">set_authorization_header</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span><span class="o">+</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
                    <span class="c1"># Handle first 401 by regenerating auth headers</span>
                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__mdf_authorizer</span><span class="o">.</span><span class="n">handle_missing_authorization</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__mdf_authorizer</span><span class="o">.</span><span class="n">set_authorization_header</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span><span class="o">+</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
                    <span class="c1"># Handle other errors by passing the buck to the user</span>
                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="s2">&quot; when attempting to access &#39;&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">+</span><span class="n">remote_path</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span></div>


<div class="viewcode-block" id="Forge.http_return"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Forge.http_return">[docs]</a>    <span class="k">def</span> <span class="nf">http_return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return data files from the provided results using HTTPS.</span>
<span class="sd">        For more than HTTP_NUM_LIMIT (defined above) files, you should use globus_download(), which uses Globus Transfer.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        results (dict): The records from which files should be fetched.</span>
<span class="sd">                        This should be the return value of a search method.</span>
<span class="sd">        verbose (bool): If True, status and progress messages will be printed.</span>
<span class="sd">                        If False, only error messages will be printed.</span>
<span class="sd">                        Default True.</span>

<span class="sd">        Returns:</span>
<span class="sd">        list of str: Text data of the data files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">http_stream</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">))</span></div></div>



<div class="viewcode-block" id="Query"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Query">[docs]</a><span class="k">class</span> <span class="nc">Query</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;The Query class is meant for use through Forge. Users should generally not instantiate a Query object directly,</span>
<span class="sd">    as Forge manages all the functions a user might need, but advanced users may do so at their own risk.</span>

<span class="sd">    Queries may end up wrapped in parentheses, which has no direct effect on the search. This is to enable forcing &#39;OR&#39;</span>
<span class="sd">    terms to bind more tightly than &#39;AND&#39; terms, when the default is the opposite. It intuitively makes more sense for</span>
<span class="sd">    a query such as &quot;oqmd OR nist_janaf AND Al&quot; to be interpreted as &quot;(oqmd OR nist_janaf) AND (Al)&quot; for Forge use cases.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_client</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">advanced</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Query instance.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        search_client (SearchClient): The Globus Search client to use for searching.</span>
<span class="sd">        q (str): The query string to start with. Default nothing.</span>
<span class="sd">        limit: The maximum number of results to return. Default None.</span>
<span class="sd">        advanced: If True, will submit query in &quot;advanced&quot; mode, which enables searches other than basic fulltext.</span>
<span class="sd">                  If False, only basic fulltext term matches will be supported.</span>
<span class="sd">                  Default False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__search_client</span> <span class="o">=</span> <span class="n">search_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">advanced</span> <span class="o">=</span> <span class="n">advanced</span>


<div class="viewcode-block" id="Query.match_term"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Query.match_term">[docs]</a>    <span class="k">def</span> <span class="nf">match_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">match_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a term to the query.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        term (str): The term to add.</span>
<span class="sd">        match_all (bool): If True, will add term with AND. If False, will use OR. Default True.</span>

<span class="sd">        Returns:</span>
<span class="sd">        self (Query): For chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;) AND (&quot;</span> <span class="k">if</span> <span class="n">match_all</span> <span class="k">else</span> <span class="s2">&quot; OR &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">term</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Query.match_field"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Query.match_field">[docs]</a>    <span class="k">def</span> <span class="nf">match_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">match_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a field:value term to the query.</span>
<span class="sd">        Matches will have field == value.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        field (str): The field to look in for the value.</span>
<span class="sd">            The field must be namespaced according to Elasticsearch rules, which means a dot to dive into dictionaries.</span>
<span class="sd">            Ex. &quot;mdf.source_name&quot; is the &quot;source_name&quot; field of the &quot;mdf&quot; dictionary.</span>
<span class="sd">            If no namespace is provided, the default (&quot;mdf.&quot;) will be used.</span>
<span class="sd">        value (str): The value to match.</span>
<span class="sd">        match_all: If True, will add with AND. If False, will use OR. Default True.</span>
<span class="sd"> </span>
<span class="sd">        Returns:</span>
<span class="sd">        self (Query): For chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># match_all determines AND/OR</span>
        <span class="n">match_join</span> <span class="o">=</span> <span class="s2">&quot;) AND (&quot;</span> <span class="k">if</span> <span class="n">match_all</span> <span class="k">else</span> <span class="s2">&quot; OR &quot;</span>
        <span class="c1"># If no namespacing provided, add default</span>
        <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="s2">&quot;mdf.&quot;</span> <span class="o">+</span> <span class="n">field</span>
        <span class="c1"># If value list should be OR&#39;d</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">match_all</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="c1"># Make value into list for processing</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">+=</span> <span class="p">(</span><span class="n">match_join</span> <span class="o">+</span> <span class="n">field</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">val</span><span class="p">)</span>
        <span class="c1"># Field matches are advanced queries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">advanced</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Query.search"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Query.search">[docs]</a>    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">advanced</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute a search and return the results.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        q (str): The query to execute. Defaults to the current query, if any. There must be some query to execute.</span>
<span class="sd">        advanced (bool): If True, will submit query in &quot;advanced&quot; mode, which enables searches other than basic fulltext.</span>
<span class="sd">                         If False, only basic fulltext term matches will be supported.</span>
<span class="sd">                         Default False.</span>
<span class="sd">                         This value can change to True automatically if the query is built using advanced features, such as match_field.</span>
<span class="sd">        limit (int): The maximum number of results to return. The max for this argument is the SEARCH_LIMIT imposed by Globus Search. Default 10.</span>
<span class="sd">        info (bool): If False, search will return a list of the results.</span>
<span class="sd">                     If True, search will return a tuple containing the results list, and other information about the query.</span>
<span class="sd">                     Default False.</span>

<span class="sd">        Returns:</span>
<span class="sd">        list (if info=False): The results.</span>
<span class="sd">        tuple (if info=True): The results, and a dictionary of query information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">q</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;()&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: No query specified&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">advanced</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">advanced</span><span class="p">:</span>
            <span class="n">advanced</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">advanced</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="ow">or</span> <span class="n">SEARCH_LIMIT</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="o">&gt;</span> <span class="n">SEARCH_LIMIT</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">SEARCH_LIMIT</span>

        <span class="c1"># Balance parentheses</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">while</span> <span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
            <span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">q</span>
        <span class="c1"># Clean query string</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;( OR&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">)</span>
        <span class="n">removes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;()&quot;</span><span class="p">,</span> <span class="s2">&quot;AND&quot;</span><span class="p">,</span> <span class="s2">&quot;OR&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">rterm</span> <span class="ow">in</span> <span class="n">removes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">rterm</span><span class="p">):</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">rterm</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">rterm</span><span class="p">):</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">rterm</span><span class="p">)]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Simple query (max 10k results)</span>
        <span class="n">qu</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="n">q</span><span class="p">,</span>
            <span class="s2">&quot;advanced&quot;</span><span class="p">:</span> <span class="n">advanced</span><span class="p">,</span>
            <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">limit</span>
            <span class="p">}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">gmeta_pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__search_client</span><span class="o">.</span><span class="n">structured_search</span><span class="p">(</span><span class="n">qu</span><span class="p">),</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
        <span class="c1"># Add additional info</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;query&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qu</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="Query.aggregate_source"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Query.aggregate_source">[docs]</a>    <span class="k">def</span> <span class="nf">aggregate_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Aggregate all records from a given source.</span>
<span class="sd">        There is no inherent limit to the number of results returned.</span>
<span class="sd">        Note that this method does not use or alter the current query.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        source (str): The source to aggregate.</span>
<span class="sd">        limit (int): The maximum number of results to return. Default None, to return all results.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        list of dict: All of the records from the source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">full_res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Start res as value that will pass while condition</span>
        <span class="c1"># Scroll while results are being returned and limit not reached</span>
        <span class="k">while</span> <span class="n">res</span> <span class="ow">and</span> <span class="p">(</span><span class="n">limit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="s2">&quot;mdf.source_name:&quot;</span> <span class="o">+</span> <span class="n">source</span> <span class="o">+</span> <span class="s2">&quot; AND mdf.scroll_id:(&gt;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">full_res</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; AND &lt;=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_res</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">limit</span> <span class="ow">or</span> <span class="n">SEARCH_LIMIT</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;advanced&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">limit</span> <span class="ow">or</span> <span class="n">SEARCH_LIMIT</span>
                <span class="p">}</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">gmeta_pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__search_client</span><span class="o">.</span><span class="n">structured_search</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
            <span class="n">num_res</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="n">full_res</span> <span class="o">+=</span> <span class="n">res</span>
            <span class="c1"># If a limit was set, lower future limit by number of results saved</span>
            <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
                <span class="n">limit</span> <span class="o">-=</span> <span class="n">num_res</span>
        <span class="k">return</span> <span class="n">full_res</span></div>

<div class="viewcode-block" id="Query.aggregate"><a class="viewcode-back" href="../../mdf_forge.html#mdf_forge.forge.Query.aggregate">[docs]</a>    <span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scroll_size</span><span class="o">=</span><span class="n">SEARCH_LIMIT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gather all results that match a specific query</span>

<span class="sd">        Note that all aggregate queries run in advanced mode.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        q (str): The query to execute. Defaults to the current query, if any. There must be some query to execute.</span>
<span class="sd">        advanced (bool): If True, will submit query in &quot;advanced&quot; mode, which enables searches other than basic fulltext.</span>
<span class="sd">                         If False, only basic fulltext term matches will be supported.</span>
<span class="sd">                         Default False.</span>
<span class="sd">                         This value can change to True automatically if the query is built using advanced features, such as match_field.</span>
<span class="sd">        scroll_size (int): Maximum number of records requested per request</span>

<span class="sd">        Returns:</span>
<span class="sd">        list of dict: All matching records</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">q</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;()&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: No query specified&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Balance parentheses</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
            <span class="n">q</span> <span class="o">+=</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">while</span> <span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">q</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
            <span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">q</span>
        <span class="c1"># Clean query string</span>
        <span class="n">removes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;()&quot;</span><span class="p">,</span> <span class="s2">&quot;AND&quot;</span><span class="p">,</span> <span class="s2">&quot;OR&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">rterm</span> <span class="ow">in</span> <span class="n">removes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">rterm</span><span class="p">):</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">rterm</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">rterm</span><span class="p">):</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">rterm</span><span class="p">)]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Get the total number of records</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__search_client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">advanced</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>

        <span class="c1"># Scroll until all results are found</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scroll_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">total</span><span class="p">:</span>

                <span class="c1"># Scroll until the width is small enough to get all records</span>
                <span class="c1">#   `scroll_id`s are unique to each dataset. If multiple datasets</span>
                <span class="c1">#   match a certain query, the total number of matching records</span>
                <span class="c1">#   may exceed the maximum that serach will return - even if the</span>
                <span class="c1">#   scroll width is much smaller than that maximum</span>
                <span class="n">scroll_width</span> <span class="o">=</span> <span class="n">scroll_size</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">result_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__search_client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">q</span> <span class="o">+</span>
                                                                 <span class="s1">&#39;) AND mdf.scroll_id:&gt;=</span><span class="si">%d</span><span class="s1"> AND mdf.scroll_id:&lt;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                                     <span class="n">scroll_pos</span><span class="p">,</span> <span class="n">scroll_pos</span> <span class="o">+</span> <span class="n">scroll_width</span><span class="p">),</span>
                                                                 <span class="n">advanced</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">SEARCH_LIMIT</span><span class="p">)</span>

                    <span class="c1"># Check to make sure that all the matching records were returned</span>
                    <span class="k">if</span> <span class="n">result_records</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">result_records</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]:</span>
                        <span class="k">break</span>

                    <span class="c1"># If not, reduce the scroll width</span>
                    <span class="n">scroll_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">scroll_width</span> <span class="o">*</span> <span class="p">(</span><span class="n">result_records</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">result_records</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]))</span>

                <span class="c1"># Append the results to the output</span>
                <span class="n">output</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">toolbox</span><span class="o">.</span><span class="n">gmeta_pop</span><span class="p">(</span><span class="n">result_records</span><span class="p">))</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result_records</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">])</span>
                <span class="n">scroll_pos</span> <span class="o">+=</span> <span class="n">scroll_width</span>

        <span class="k">return</span> <span class="n">output</span></div></div>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">mdf_forge</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Ben Blaiszik, Jonathon Gaff.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>